<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>STTê²Œì„ ì´ë²¤íŠ¸ ì¢…ë£Œ</title>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@700&display=swap" rel="stylesheet">
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™” */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* ì›¹í°íŠ¸ ë° ë ˆì´ì•„ì›ƒ ì„¤ì • */
        body {
            font-family: 'Nanum Gothic','Arial', sans-serif;
            background-color: #f4f4f4;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            text-align: center;
            line-height: 1.5;
        }

        .container {
            max-width: 600px;
            width: 100%;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.9); 
            border-radius: 10px;
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

        h1 {
            font-size: 40px;
            margin-bottom: 20px;
        }
        p {
            margin-bottom: 15px;
            font-size: 20px;
        }

        /* ë­í‚¹ ë³´ë“œ: ë©”ì¸ í˜ì´ì§€ì—ì„œ ìƒìœ„ 5ëª…ì„ ë³´ì—¬ì¤„ ì˜ì—­ */
        #ranking-board-container {
            text-align: center;
            font-size: 20px;
            position: relative;
            padding: 20px 20px;
            border-radius: 10px;
            background-color: rgba(255, 255, 0, 0.5);
            color: black;
            font-weight: bold;
            font-family: 'Nanum Gothic', 'Malgun Gothic', sans-serif;
            line-height: 1.6;
            width: 80%;
            max-width: 600px;
            margin: 20px auto;
            display: none; /* ì²˜ìŒì—ëŠ” ìˆ¨ê²¨ë†“ê³ , JSì—ì„œ displayRankings() í›„ í‘œì‹œ */
        }

        #ranking-list div {
            margin: 10px 0;
            padding: 5px;
            font-size: 17px;
            text-align: left;
        }

        /* "ë”ë³´ê¸°" ë²„íŠ¼ */
        #rankmore {
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s;
            margin-top: 10px;
            display: none; /* ìƒìœ„ 5ëª…ì— ë” ë³´ì—¬ì¤„ í•­ëª©ì´ ìˆì„ ë•Œë§Œ ë³´ì´ë„ë¡ JS ì œì–´ */
        }
        #rankmore:hover {
            background-color: #0056b3;
            transform: translateY(-2px);
        }

        /* ë°°ê²½ ì´ë¯¸ì§€(letters.gif) */
        #background-image {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: -1;
            overflow: hidden;
        }
        #background-image img {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0.2;
            width: 150%;
            height: auto;
            animation: rotate 60s linear infinite;
        }
        @keyframes rotate {
            0% {
                transform: translate(-50%, -50%) rotate(0deg);
            }
            100% {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }
    </style>
</head>
<body onload="displayRankings()">
    <div class="container">
        <!-- ì´ë²¤íŠ¸ ì¢…ë£Œ ì•ˆë‚´ -->
        <h1>STTê²Œì„ì— ì°¸ì—¬í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤</h1>
        <p>ë³¸ ì´ë²¤íŠ¸ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</p>
        <p>ì•„ë˜ ë­í‚¹ ë³´ë“œë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!</p>
    </div>

    <!-- ìƒìœ„ 5ëª… ë­í‚¹ ë³´ë“œ -->
    <div id="ranking-board-container">
        <h3>ğŸ“‹ ë­í‚¹ ë³´ë“œ (ìƒìœ„ 5ëª…) ğŸ“‹</h3>
        <div id="ranking-list"></div>
        <button id="rankmore" onclick="rankmore()">ë”ë³´ê¸°â‹¯</button>
    </div>

    <!-- ë°°ê²½ ì´ë¯¸ì§€ -->
    <div id="background-image">
        <img src="{{ url_for('static', filename='images/letters.gif') }}" alt="Background Animation">
    </div>

    <script>
        /**
         * ë­í‚¹ ë³´ë“œ: ìƒìœ„ 5ëª… í‘œì‹œ
         * ì„œë²„ë¡œë¶€í„° /get_rankings?timestamp=... ë¡œ JSON ë°ì´í„°ë¥¼ fetch
         */
        function displayRankings() {
            const rankingBoard = document.getElementById('ranking-board-container');
            const rankingList = document.getElementById('ranking-list');
            const rankmoreBtn = document.getElementById('rankmore');

            if (!rankingBoard || !rankingList) return;

            // ë¡œë”© ë©”ì‹œì§€
            rankingList.innerHTML = '<div>ë¡œë”© ì¤‘...</div>';
            // ë³´ë“œ í‘œì‹œ (ë¡œë”© ì¤‘ì´ë¼ë„ ì˜ì—­ì„ ë³´ì´ê²Œ í•¨)
            rankingBoard.style.display = 'block';

            // ì‹¤ì œ ìš”ì²­: /get_rankings?timestamp=...
            // ë§Œì•½ ì •ì  íŒŒì¼ë¡œ ì§ì ‘ í˜¸ì¶œ ì‹œ, ì•„ë˜ì™€ ê°™ì´ ìˆ˜ì •:
            // fetch('ranking_data.json?timestamp=' + Date.now())
            fetch('/get_rankings?timestamp=' + Date.now())
                .then(response => response.json())
                .then(data => {
                    if (!data.rankings || data.rankings.length === 0) {
                        throw new Error("No rankings available from server");
                    }

                    // 1) ë¶€ì •í–‰ìœ„ ì œì™¸
                    let filteredRankings = data.rankings.filter(entry => entry.status !== "ë¶€ì •í–‰ìœ„");
                    if (filteredRankings.length === 0) {
                        throw new Error("No valid (non-cheater) rankings available");
                    }

                    // 2) ì •ë ¬: ì°¸ì—¬íšŸìˆ˜(desc) â†’ score(desc) â†’ responseTime(asc)
                    filteredRankings.sort((a, b) => {
                        // ì°¸ì—¬íšŸìˆ˜ ë‚´ë¦¼ì°¨ìˆœ
                        if (b.participationCount !== a.participationCount) {
                            return b.participationCount - a.participationCount;
                        }
                        // ì ìˆ˜ ë‚´ë¦¼ì°¨ìˆœ
                        if (b.score !== a.score) {
                            return b.score - a.score;
                        }
                        // ì‘ë‹µ ì‹œê° ì˜¤ë¦„ì°¨ìˆœ
                        const aTime = new Date(a.responseTime).getTime();
                        const bTime = new Date(b.responseTime).getTime();
                        return aTime - bTime;
                    });

                    rankingList.innerHTML = '';

                    // ìƒìœ„ 5ëª…
                    const topFive = filteredRankings.slice(0, 5);

                    topFive.forEach((entry, index) => {
                        const rankItem = document.createElement('div');
                        // ì ìˆ˜ ìµœëŒ€ 100 ì œí•œ
                        const displayScore = Math.min(entry.score, 100);

                        // ì˜ˆ) "í™ê¸¸ë™ (ë†ì‹¬) - ì°¸ì—¬ 3íšŒ(ìµœê³ ì ìˆ˜ 95)"
                        const rankText = `${entry.name} (${entry.company}) - ì°¸ì—¬ ${entry.participationCount}íšŒ(ìµœê³ ì ìˆ˜ ${displayScore})`;

                        // ë“±ìˆ˜ë³„ ìŠ¤íƒ€ì¼
                        if (index === 0) {
                            rankItem.innerHTML = `<span style="font-weight:bold; color: rgba(0,0,0,1);">1ë“±ğŸ¥‡ ${rankText}</span>`;
                        } else if (index === 1) {
                            rankItem.innerHTML = `<span style="font-weight:bold; color: rgba(0,0,0,0.8);">2ë“±ğŸ¥ˆ ${rankText}</span>`;
                        } else if (index === 2) {
                            rankItem.innerHTML = `<span style="font-weight:bold; color: rgba(0,0,0,0.6);">3ë“±ğŸ¥‰ ${rankText}</span>`;
                        } else {
                            const alpha = Math.max(0.4, 1 - index * 0.1);
                            rankItem.innerHTML = `<span style="color: rgba(0,0,0,${alpha});">${index + 1}ë“±ğŸ™„ ${rankText}</span>`;
                        }

                        rankingList.appendChild(rankItem);
                    });

                    // "ë”ë³´ê¸°" ë²„íŠ¼ ë…¸ì¶œ ì—¬ë¶€ (ìƒìœ„ 5ëª…ìœ¼ë¡œ ì˜ë¦° ê²½ìš°ë§Œ)
                    if (filteredRankings.length > 5) {
                        rankmoreBtn.style.display = 'inline-block';
                    } else {
                        rankmoreBtn.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.error('ë­í‚¹ ë¡œë“œ ì˜¤ë¥˜:', error);
                    rankingList.innerHTML = '<div>ë­í‚¹ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                    if (rankmoreBtn) {
                        rankmoreBtn.style.display = 'none';
                    }
                });
        }

        /**
         * "ë”ë³´ê¸°" ë²„íŠ¼ í´ë¦­ ì‹œ, ì „ì²´ ë­í‚¹ íŒì—…
         * /get_rankings?all=true ë¡œ ì „ì²´ ë°ì´í„° ìš”ì²­
         */
        function rankmore() {
            const popup = window.open("", "RankPopup", "width=600,height=800");
            if (!popup) {
                alert("íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. í•´ì œ í›„ ë‹¤ì‹œ ì‹œë„!");
                return;
            }

            // íŒì—… ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ì‘ì„±
            popup.document.write(`
                <html>
                <head>
                    <title>ì „ì²´ ë­í‚¹</title>
                    <style>
                        body {
                            font-family: 'Nanum Gothic', sans-serif;
                            background-color: #f9f9f9;
                            text-align: center;
                            margin: 0; padding: 20px;
                        }
                        #popup-ranking-board {
                            margin: 0 auto; padding: 20px;
                            border-radius: 10px;
                            background-color: rgba(255, 255, 0, 0.5);
                            color: black; font-weight: bold;
                            line-height: 1.6; width: 80%;
                            max-width: 500px;
                        }
                        .rank-entry {
                            margin: 10px 0; font-size: 16px; text-align: left;
                        }
                        .ranking-info {
                            font-size: 14px; /* ì•ˆë‚´ ë¬¸êµ¬ í¬ê¸° */
                            color: #666; /* íë¦¿í•œ íšŒìƒ‰ */
                            margin-bottom: 10px;
                        }
                    </style>
                </head>
                <body>
                    <div class="ranking-info">ë­í‚¹ì€ ì°¸ì—¬íšŸìˆ˜ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•˜ë©°, ë™ì¼ ì°¸ì—¬íšŸìˆ˜ ì‹œ ë¨¼ì € ì°¸ì—¬í•œ ìˆœì„œë¡œ ì„ ì •ë©ë‹ˆë‹¤.</div>
                    <h2>ğŸ† ì „ì²´ ë­í‚¹ ğŸ†</h2>
                    <div id="popup-ranking-board">ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                    <div class="ranking-info">ë¶€ì •í–‰ìœ„ë¥¼ í†µí•œ ì°¸ì—¬ ì‹œ ìƒí’ˆì§€ê¸‰ì´ ì œí•œë©ë‹ˆë‹¤.</div>
                </body>
                </html>
            `);

            const popupDoc = popup.document;

            // ì „ì²´ ë­í‚¹ ë¶ˆëŸ¬ì˜¤ê¸°
            // ì •ì  íŒŒì¼ í˜¸ì¶œ ì‹œ: fetch('ranking_data.json?all=true')
            // ì—¬ê¸°ì„œëŠ” /get_rankings?all=true ë¼ìš°íŠ¸ ì˜ˆì‹œ
            fetch('/get_rankings?all=true')
                .then(res => {
                    if (!res.ok) {
                        throw new Error('ë­í‚¹ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
                    }
                    return res.json();
                })
                .then(data => {
                    let entireRankings = data.rankings || [];

                    // 1) ë¶€ì •í–‰ìœ„ ì œì™¸
                    entireRankings = entireRankings.filter(entry => entry.status !== "ë¶€ì •í–‰ìœ„");
                    if (entireRankings.length === 0) {
                        throw new Error("No valid (non-cheater) rankings available");
                    }

                    // 2) ë™ì¼í•œ ì •ë ¬ ë¡œì§
                    entireRankings.sort((a, b) => {
                        if (b.participationCount !== a.participationCount) {
                            return b.participationCount - a.participationCount;
                        }
                        if (b.score !== a.score) {
                            return b.score - a.score;
                        }
                        const aTime = new Date(a.responseTime).getTime();
                        const bTime = new Date(b.responseTime).getTime();
                        return aTime - bTime;
                    });

                    const container = popupDoc.getElementById('popup-ranking-board');
                    container.innerHTML = '';

                    entireRankings.forEach((entry, index) => {
                        const div = popupDoc.createElement('div');
                        div.className = 'rank-entry';

                        const displayScore = Math.min(entry.score, 100);
                        const rankText = `${entry.name} (${entry.company}) - ì ìˆ˜: ${displayScore}, ì°¸ì—¬: ${entry.participationCount}íšŒ`;

                        if (index === 0) {
                            div.innerHTML = `<span style="font-weight:bold; color: rgba(0,0,0,1);">1ë“±ğŸ¥‡ ${rankText}</span>`;
                        } else if (index === 1) {
                            div.innerHTML = `<span style="font-weight:bold; color: rgba(0,0,0,0.8);">2ë“±ğŸ¥ˆ ${rankText}</span>`;
                        } else if (index === 2) {
                            div.innerHTML = `<span style="font-weight:bold; color: rgba(0,0,0,0.6);">3ë“±ğŸ¥‰ ${rankText}</span>`;
                        } else {
                            const alpha = Math.max(0.4, 1 - index * 0.1);
                            div.innerHTML = `<span style="color: rgba(0,0,0,${alpha});">${index+1}ë“±ğŸ™„ ${rankText}</span>`;
                        }

                        container.appendChild(div);
                    });
                })
                .catch(err => {
                    console.error(err);
                    const container = popupDoc.getElementById('popup-ranking-board');
                    container.innerHTML = `<p style="color:red;">ì˜¤ë¥˜ ë°œìƒ: ${err.message}</p>`;
                });
        }
    </script>
</body>
</html>
