<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë„ˆêµ¬ë¦¬ë¥¼ ê°€ì ¸ì™€</title>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Gothic:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #ffffff;
        }
        canvas {
            background: #ffd900;
        }
        
        #loadingScreen {
            text-align: center;
            font-size: 24px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            border-radius: 10px;
            display: none;
        }

        #loadingScreen img {
            width: 300px; /* í•„ìš”ì— ë”°ë¼ í¬ê¸°ë¥¼ ì¡°ì • */
            height: auto;
        }

        #formContainer {
            text-align: center;
            font-size: 20px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding-top: 15px;    /* ìƒë‹¨ íŒ¨ë”© */
            padding-right: 10px;  /* ìš°ì¸¡ íŒ¨ë”© */
            padding-bottom: 15px; /* í•˜ë‹¨ íŒ¨ë”© */
            padding-left: 10px;   /* ì¢Œì¸¡ íŒ¨ë”© */
            border-radius: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            display: none;
        }

        #startMessage {
            text-align: center;
            font-size: 24px;
            position: absolute;
            top: 70%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            border-radius: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            display: none;
        }        


        #message {
            text-align: center;
            font-size: 18px;
            position: absolute;
            top: 80%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            border-radius: 10px;            
            color: black;
            font-weight: bold;
            font-family: 'Nanum Gothic', 'Malgun Gothic', sans-serif;
            display: none;
        }       

        #exit {
            text-align: center;
            font-size: 24px;
            position: absolute;
            top: 60%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            border-radius: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            display: none;
        }      
        
        
        #loadingScreen {
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
        }

        #startButton, #prepare {
            text-align: center;
            font-size: 24px;
            position: absolute;
            top: 75%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 10px;
            border-radius: 10px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            display: none;
        }

        #startButton:hover, #prepare:hover, #exit:hover, #startMessage:hover {
            background-color: white;
            color: black;
            border: 2px solid #4CAF50;
        }
        
       
        #gameDescription {
            text-align: center;
            font-size: 16px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding-top: 5px;    /* ìƒë‹¨ íŒ¨ë”© */
            padding-right: 10px;  /* ìš°ì¸¡ íŒ¨ë”© */
            padding-bottom: 5px; /* í•˜ë‹¨ íŒ¨ë”© */
            padding-left: 10px;   /* ì¢Œì¸¡ íŒ¨ë”© */
            border-radius: 10px;
            display: none;
            background-color: rgba(255, 255, 255, 0.9);
            color: black;
            font-weight: bold;
            font-family: 'Nanum Gothic', 'Malgun Gothic', sans-serif;
        }

        
        #rankingBoard {
            text-align: center;
            font-size: 20px;
            position: absolute;
            top: 40%;
            left: 50%;            
            transform: translate(-50%, -50%);
            padding: 20px;
            border-radius: 10px;
            display: none;
            background-color: rgba(255, 255, 0, 0.5);
            color: black;
            font-weight: bold;
            font-family: 'Nanum Gothic', 'Malgun Gothic', sans-serif;
            line-height: 1.6; /* ì¤„ ê°„ê²© ì¡°ì ˆ */
        }
        
        .styled-button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 5px 10px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 8px 4px;
            cursor: pointer;
            border-radius: 12px;
            transition-duration: 0.4s;
        }
        .styled-button:hover {
            background-color: white;
            color: black;
            border: 2px solid #4CAF50;
        }
        .game-start {
            margin-bottom: 32px; /* ê²Œì„ ì‹œì‘ ë¬¸êµ¬ ì•„ë˜ì— ì—¬ë°± ì¶”ê°€ */
        }
        .ranking-section {
            margin-top: 16px; 
        }
        #characterSelection, #difficultySelection {
            display: none;
            text-align: center;
            margin-top: 20px;
        }

        .character-option {
            margin: 10px;
            cursor: pointer;
            border: 2px solid transparent;
            border-radius: 10px;
            transition: border-color 0.3s;
            width: 100px; /* ì´ë¯¸ì§€ ë„ˆë¹„ ì¡°ì • */
            height: auto; /* ìë™ ë†’ì´ ì¡°ì • */
        }

        .character-option:hover, .difficulty-option:hover {
            border-color: blue;
        }

        .selected {
            border: 2px solid red;
        }

        #startButtonContainer {
            text-align: center;
            margin-top: 20px;
        }
        #audioControls {
            position: fixed;
            top: calc(50% - 300px - 40px); /* í™”ë©´ ì¤‘ì•™ì—ì„œ ìº”ë²„ìŠ¤ ë†’ì´ì˜ ì ˆë°˜ê³¼ ë²„íŠ¼ ìœ„ì¹˜ë¥¼ ì¡°ì • */
            right: calc(50% - 320px); /* í™”ë©´ ì¤‘ì•™ì—ì„œ ìº”ë²„ìŠ¤ ë„ˆë¹„ì˜ ì ˆë°˜ì„ ì¡°ì • */
        }        
    </style>
</head>
<body>
    <div id="gameDescription">
        <p>ê³¼ì—° ë„ˆêµ¬ë¦¬ì”¨ğŸ¦ëŠ” ë¼ë©´ë“¤ì„ ê°€ì§€ê³ </p>
        <p>ì €ë…ì‹ì‚¬ ì‹œê°„â± ì „ì— ëŒì•„ ê°ˆ ìˆ˜ ìˆì„ê¹Œìš”?</p>
        <p>ë‹¨ì§ì¹œêµ¬ ë‹¤ì‹œë§ˆë“¤ì´ ë„ì™€ì¤„í…Œë‹ˆ ë„ˆë¬´ ê±±ì •ë§ˆì„¸ìš”^^</p>
        <p>Tipâ— ë‹¤ì‹œë§ˆê°€ ìš¸í‰ë¶ˆí‰í•˜ë‹ˆ ì í”„ì— ì£¼ì˜</p>
        <p class="game-start">'ì¤€ë¹„í•˜ê¸°' ë²„íŠ¼ì„ í´ë¦­ğŸ‘†í•˜ì„¸ìš”.</p> <!-- ì—¬ë°± ì¶”ê°€ -->
        <p class="ranking-section">ğŸ†ë­í‚¹ 1ë“±ğŸ† ë„ˆêµ¬ë¦¬ ë©€í‹°íŒ©(40ì…)</p>
        <p>ğŸ¥‡ë­í‚¹ 2ë“±ğŸ¥‡ ë„ˆêµ¬ë¦¬ì»µ(30ì…)</p>
        <p>ğŸ¥ˆë­í‚¹ 3ë“±ğŸ¥ˆ ì¹´êµ¬ë¦¬í°ì‚¬ë°œ(16ì…)</p>
        <p>ğŸ‘¥ì°¸ì—¬ì ì¶”ì²¨(7ëª…)ğŸ‘¥ ëˆ„ë“¤í• ì¹´êµ¬ë¦¬ë§›(8ì…)</p>
    </div>
    
    <div id="formContainer">
        <label>íšŒì‚¬: <input type="text" id="company"></label><br>
        <label>ì‚¬ë²ˆ: <input type="text" id="employeeId"></label><br>
        <label>ì´ë¦„: <input type="text" id="name"></label><br>
        <button class="styled-button" onclick="sendToGoogleSheets()">ì´ë²¤íŠ¸ ì‘ëª¨í•˜ê¸°</button>
        <button class="styled-button" onclick="restartGame()">ë‹¤ì‹œí•˜ê¸°</button>
    </div>
    
    <div id="loadingScreen">
    <img src="https://github.com/cost6885/tbon2/raw/main/image/loading.gif">
    </div>
    
    <canvas id="gameCanvas" width="640" height="600"></canvas>
    
    <div id="startMessage" onclick="prapare()">ë‹¤ì‹œ ì‹œì‘</div>

    <div id="exit" onclick="closeWindow()">ë‚˜ê°€ê¸°</div>

    <div id="message"></div>
    
    <div id="rankingBoard"></div>

    <button id="prepare" onclick="prapare()">ì¤€ë¹„í•˜ê¸°</button>

    <div id="characterSelection">
        <h3>ìºë¦­í„°ë¥¼ ì„ íƒí•˜ì„¸ìš”</h3>
        <img src="https://github.com/cost6885/tbon2/raw/main/image/racoon1.gif" class="character-option" onclick="selectCharacter('https://github.com/cost6885/tbon2/raw/main/image/racoon1.gif')">
        <img src="https://github.com/cost6885/tbon2/raw/main/image/racoon2.gif" class="character-option" onclick="selectCharacter('https://github.com/cost6885/tbon2/raw/main/image/racoon2.gif')">
    </div>

    <div id="difficultySelection">
        <h3>ë‚œì´ë„ë¥¼ ì„ íƒí•˜ì„¸ìš”</h3>
        <button class="difficulty-option styled-button" onclick="selectDifficulty('easy')">ì‰¬ì›€</button>
        <button class="difficulty-option styled-button" onclick="selectDifficulty('hard')">ì–´ë ¤ì›€</button>
    </div>

    <div id="startButtonContainer">
        <button id="startButton" class="styled-button" onclick="startGame()">ê²Œì„ ì‹œì‘</button>
    </div>

    <div id="audioControls">
        <button onclick="pauseAudio()">BGM OFFğŸ”ˆ</button>
        <button onclick="playAudio()">BGM ONğŸ”Š</button>        
    </div>

    <!-- BGM ì¶”ê°€ -->
    <audio id="bgm" loop>
        <source src="https://firebasestorage.googleapis.com/v0/b/driven-cabinet-381405.appspot.com/o/%5BRoyalty%20Free%20Music%5D%20Ponpoko%20(8bit%20game%20retro).mp3?alt=media&token=d99399f7-fd8f-4d65-87bd-0c70ffc37bf3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>
    

    <script>
        var canvas, ctx, ballRadius = 10, x, y, dx = 6, dy = -6, paddleHeight = 47, paddleWidth = 133, paddleX;
        var rightPressed = false, leftPressed = false;
        var brickRowCount = 2, brickColumnCount = 6, brickWidth = 100, brickHeight = 108, brickPadding = 0, brickOffsetTop = 20, brickOffsetLeft = 20;
        var bricks = [], score = 0, gameStarted = false, startTime, elapsedTime;
        var brickImage, image, canvasImage;
        var enlargedBallRadius = ballRadius * 5;
        var ballImage = new Image();
        var characterSelected = false;
        var difficultySelected = false;
        var difficulty = 'easy';
        var audio = document.getElementById('bgm');

        document.addEventListener("DOMContentLoaded", function() {
            showLoadingScreen();
            canvas = document.getElementById("gameCanvas");
            ctx = canvas.getContext("2d");

            document.addEventListener("keydown", keyDownHandler);
            document.addEventListener("keyup", keyUpHandler);
            
            brickImage = new Image();
            brickImage.src = "https://github.com/cost6885/tbon2/raw/main/image/block.png";

            canvasImage = new Image();
            canvasImage.src = 'https://github.com/cost6885/tbon2/raw/main/image/ramenbg.jpg';

            canvasImage.onload = function() {
                ctx.globalAlpha = 0.9;
                ctx.drawImage(canvasImage, 0, 0, canvas.width, canvas.height);
                ctx.globalAlpha = 1;
                hideLoadingScreen();                
                showStartButton();
                            
                audio.play().catch(function(error) {
                    // ìë™ ì¬ìƒ ì‹¤íŒ¨ ì‹œ, ì‚¬ìš©ì ìƒí˜¸ì‘ìš©ì„ ê¸°ë‹¤ë¦¼
                    console.log('Auto-play prevented by browser:', error);
                });
            };

            brickImage.onload = function() {
                // Brick image ë¡œë“œ í›„ ì‘ì—…ì´ í•„ìš”í•œ ê²½ìš° ì—¬ê¸°ì— ì‘ì„±
            };

            ballImage.onload = function() {
                // Ball image ë¡œë“œ í›„ ì‘ì—…ì´ í•„ìš”í•œ ê²½ìš° ì—¬ê¸°ì— ì‘ì„±
            };
        });


        function closeWindow() {
            window.close();
        }

        
        function playAudio() {
            audio.play();
        }

        function pauseAudio() {
            audio.pause();
            audio.currentTime = 0;  // ì¬ìƒ ìœ„ì¹˜ë¥¼ ì²˜ìŒìœ¼ë¡œ ëŒë¦¼
        }            
        
        function prapare() {
            document.getElementById("gameDescription").style.display = 'none';
            document.getElementById("formContainer").style.display = "none";
            document.getElementById("gameCanvas").style.display = "none";
            document.getElementById("rankingBoard").style.display = "none";
            document.getElementById("startMessage").style.display = "none";
            document.getElementById("prepare").style.display = "none";
            document.getElementById("exit").style.display = "none";
            document.getElementById("characterSelection").style.display = "block";
            document.getElementById("difficultySelection").style.display = "block";
            document.getElementById("startButton").style.display = "block";

        }

        function selectCharacter(src) {
            ballImage.src = src;
            characterSelected = true;
            document.querySelectorAll('.character-option').forEach(el => el.classList.remove('selected'));
            event.target.classList.add('selected');
            checkStartCondition();
        }

        function selectDifficulty(level) {
            difficulty = level;
            difficultySelected = true;
            document.querySelectorAll('.difficulty-option').forEach(el => el.classList.remove('selected'));
            event.target.classList.add('selected');
            checkStartCondition();
        }

        function checkStartCondition() {
            if (characterSelected && difficultySelected) {
                document.getElementById('startButton').style.display = 'block';
            }
        }
        
        function showLoadingScreen() {
            document.getElementById("loadingScreen").style.display = "block";
        }

        function hideLoadingScreen() {
            document.getElementById("loadingScreen").style.display = "none";
        }

        function showStartButton() {
            document.getElementById('prepare').style.display = 'block';
            document.getElementById('gameDescription').style.display = 'block';
        }

        function drawBackground() {
            ctx.globalAlpha = 0.3; // íˆ¬ëª…ë„ ì„¤ì • (0.0ì—ì„œ 1.0 ì‚¬ì´ ê°’)
            ctx.drawImage(canvasImage, 0, 0, canvas.width, canvas.height);  // ë°°ê²½ ì´ë¯¸ì§€ ê·¸ë¦¬ê¸°
            ctx.globalAlpha = 1.0; // íˆ¬ëª…ë„ ì›ë˜ëŒ€ë¡œ ëŒë¦¬ê¸°
        }
        
        function initGame() {
            console.log("Initializing game...");
            x = canvas.width / 4; // ê³µì˜ ì´ˆê¸° ìœ„ì¹˜ë¥¼ ìº”ë²„ìŠ¤ì˜ 3ë¶„ì˜ 1 ì§€ì ìœ¼ë¡œ ì„¤ì •
            y = canvas.height - paddleHeight - enlargedBallRadius; // íŒ¨ë“¤ ìœ„ë¡œ ê³µì˜ ì´ˆê¸° ìœ„ì¹˜ ì„¤ì •
            dx = 7;
            dy = -7;
            paddleX = (canvas.width - paddleWidth) / 3; // íŒ¨ë“¤ì˜ ì´ˆê¸° ìœ„ì¹˜ë¥¼ ìº”ë²„ìŠ¤ì˜ 3ë¶„ì˜ 1 ì§€ì ìœ¼ë¡œ ì„¤ì •
        
            bricks = [];
            for (var c = 0; c < brickColumnCount; c++) {
                bricks[c] = [];
                for (var r = 0; r < brickRowCount; r++) {
                    bricks[c][r] = { x: 0, y: 0, status: 1 };
                }
            }
        
            score = 0;
            document.getElementById("message").style.display = "none";
            document.getElementById("startMessage").style.display = "none";
            document.getElementById('prepare').style.display = 'none';
            document.getElementById("characterSelection").style.display = "none";
            gameStarted = false; // Ensure gameStarted is reset
            elapsedTime = 0;
            console.log("Game initialized.");
        }


        function restartGame() {
            document.getElementById("formContainer").style.display = "none";
            document.getElementById("rankingBoard").style.display = "none";
            initGame();
            gameStarted = true;
            startTime = Date.now();
            draw();
        }

        function keyDownHandler(e) {
            if (e.key === "Right" || e.key === "ArrowRight") {
                rightPressed = true;
            } else if (e.key === "Left" || e.key === "ArrowLeft") {
                leftPressed = true;
            } else if (e.key === " " && successMessageShown) {
                document.getElementById("startMessage").style.display = "none";
                initGame();
                gameStarted = true;
                startTime = Date.now();
                successMessageShown = false;
                draw();
            }
        }

        function keyUpHandler(e) {
            if (e.key === "Right" || e.key === "ArrowRight") {
                rightPressed = false;
            } else if (e.key === "Left" || e.key === "ArrowLeft") {
                leftPressed = false;
            }
        }

        function drawSuccessMessage() {
            console.log("Drawing success message...");
            ctx.fillStyle = "black";
            ctx.font = "24px Arial";
            ctx.textAlign = "center";
            ctx.fillText(`ì„±ê³µ! ${elapsedTime}ì´ˆ`, canvas.width / 2, canvas.height / 2 - 20); // í™”ë©´ ì¤‘ì•™ì— ë©”ì‹œì§€ ì¶œë ¥
        
            // Calculate and store elapsed time
            var endTime = Date.now();
            elapsedTime = ((endTime - startTime) / 1000).toFixed(2);
            localStorage.setItem("elapsedTime", elapsedTime);
        
            // ìƒˆë¡œìš´ ê¸°ë¡ì„ ì €ì¥
            var name = localStorage.getItem("name") || "Unknown";
            var newEntry = { name: name, elapsedTime: parseFloat(elapsedTime) };
            saveLocalRanking(newEntry);        
        
            // Display event application form and button
            document.getElementById("formContainer").style.display = "block";
            document.getElementById("message").style.display = "block";
            
            var messageElement = document.getElementById("message");
            messageElement.style.display = "block";
            messageElement.innerText = `ì„±ê³µ! ${elapsedTime}ì´ˆ`;
        
            successMessageShown = true;
            console.log("Success message drawn.");
        }


        function drawBall() {
            ctx.drawImage(ballImage, x - enlargedBallRadius, y - enlargedBallRadius, enlargedBallRadius * 2, enlargedBallRadius * 2);
        }


        var paddleImage = new Image();    
        paddleImage.src = "https://github.com/cost6885/tbon2/raw/main/image/dasima.png";


        function drawPaddle() {
            ctx.drawImage(paddleImage, paddleX, canvas.height - paddleHeight - 10, paddleWidth, paddleHeight);
        }

        function drawBricks() {
            for (var c = 0; c < brickColumnCount; c++) {
                for (var r = 0; r < brickRowCount; r++) {
                    if (bricks[c][r].status == 1) {
                        var brickX = c * (brickWidth + brickPadding) + brickOffsetLeft;
                        var brickY = r * (brickHeight + brickPadding) + brickOffsetTop;
                        bricks[c][r].x = brickX;
                        bricks[c][r].y = brickY;
                        ctx.drawImage(brickImage, brickX, brickY, brickWidth, brickHeight);
                    }
                }
            }
        }

        function drawElapsedTime() {
            if (gameStarted) {
                elapsedTime = ((Date.now() - startTime) / 1000).toFixed(2);
                ctx.fillStyle = "white";
                ctx.font = "24px Arial";
                ctx.textAlign = "center";
                ctx.fillText(`ê²½ê³¼ì‹œê°„: ${elapsedTime}ì´ˆ`, canvas.width / 2, canvas.height * 2 / 3);
            }
        }

        function collisionDetection() {
            for (var c = 0; c < brickColumnCount; c++) {
                for (var r = 0; r < brickRowCount; r++) {
                    var b = bricks[c][r];
                    if (b.status == 1) {
                        if (x + dx > b.x && x + dx < b.x + brickWidth && y + dy > b.y && y + dy < b.y + brickHeight) {
                            if (x + enlargedBallRadius > b.x && x - enlargedBallRadius < b.x + brickWidth) {
                                dx = -dx;
                            }
                            if (y + enlargedBallRadius > b.y && y - enlargedBallRadius < b.y + brickHeight) {
                                dy = -dy;
                            }
                            b.status = 0;
                            score++;
                            if (score == brickRowCount * brickColumnCount) {
                                gameStarted = false;
                                drawSuccessMessage();
                            }
                        }
                    }
                }
            }
        
            if (y + dy > canvas.height - paddleHeight - enlargedBallRadius) {
                if (x > paddleX && x < paddleX + paddleWidth) {
                    var hitPos = (x - paddleX) / paddleWidth;
                    var angle = (hitPos - 0.5) * Math.PI / 2;  // -45ë„ì—ì„œ 45ë„ ì‚¬ì´ì˜ ê°ë„
                    var speed = Math.sqrt(dx * dx + dy * dy);
        
                    dx = speed * Math.sin(angle) * 1.5;  // ë¶€ë”ªíˆëŠ” ìœ„ì¹˜ì— ë”°ë¼ ì†ë„ ì¡°ì •
                    dy = -speed * Math.cos(angle) * 1.5;
        
                    if (difficulty === 'hard') {
                        var randAngle = (Math.random() - 0.5) * 40;
                        dx += randAngle;
        
                        var angle = Math.atan2(dy, dx);
                        var minAngle = Math.PI / 6;
        
                        if (Math.abs(angle) < minAngle) {
                            if (angle < 0) {
                                angle = -minAngle;
                            } else {
                                angle = minAngle;
                            }
                            var speed = Math.sqrt(dx * dx + dy * dy);
                            dx = speed * Math.cos(angle);
                            dy = speed * Math.sin(angle);
                        }
        
                        var minSpeed = 10;
                        var maxSpeed = 19;
                        var speed = Math.sqrt(dx * dx + dy * dy);
                        if (speed < minSpeed || speed > maxSpeed) {
                            var randomSpeed = minSpeed + Math.random() * (maxSpeed - minSpeed);
                            dx = (dx / speed) * randomSpeed;
                            dy = (dy / speed) * randomSpeed;
                        }
                    } else {
                        // ì‰¬ì›€ ë‚œì´ë„ì—ì„œëŠ” ì†ë„ë¥¼ ì¤„ì´ê³  ê°ë„ ë³€ê²½ì„ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                        var minSpeed = 5;
                        var maxSpeed = 7;
                        var speed = Math.sqrt(dx * dx + dy * dy);
                        if (speed < minSpeed || speed > maxSpeed) {
                            var randomSpeed = minSpeed + Math.random() * (maxSpeed - minSpeed);
                            dx = (dx / speed) * randomSpeed;
                            dy = (dy / speed) * randomSpeed;
                        }
                    }
        
                    y = canvas.height - paddleHeight - enlargedBallRadius;
                } else if (y + dy > canvas.height - enlargedBallRadius) {
                    gameStarted = false;
                    document.getElementById("startMessage").style.display = "block";
                    successMessageShown = true;
                    return;
                }
            }
        }

        function startGame() {
            document.getElementById("gameDescription").style.display = 'none';
            document.getElementById("formContainer").style.display = "none";
            document.getElementById("gameCanvas").style.display = "block";
            document.getElementById("rankingBoard").style.display = "none";
            document.getElementById("startMessage").style.display = "none";
            document.getElementById("startButton").style.display = "none";
            document.getElementById('characterSelection').style.display = 'none';
            document.getElementById('difficultySelection').style.display = 'none';

            var company = document.getElementById("company").value;
            var employeeId = document.getElementById("employeeId").value;
            var name = document.getElementById("name").value;
            localStorage.setItem("company", company);
            localStorage.setItem("employeeId", employeeId);
            localStorage.setItem("name", name);

            initGame();
            gameStarted = true;
            startTime = Date.now();
            draw();
        }

        function draw() {
            if (!gameStarted) return;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawBackground();
            drawBricks();
            drawBall();
            drawPaddle();
            collisionDetection();
            drawElapsedTime();

            if (x + dx > canvas.width - enlargedBallRadius || x + dx < enlargedBallRadius) {
                dx = -dx;
            }
            if (y + dy < enlargedBallRadius) {
                dy = -dy;
            } else if (y + dy > canvas.height - enlargedBallRadius) {
                if (x > paddleX - enlargedBallRadius && x < paddleX + paddleWidth + enlargedBallRadius) {
                    dy = -dy;
                    y = canvas.height - paddleHeight - enlargedBallRadius;
                } else {
                    gameStarted = false;
                    document.getElementById("startMessage").style.display = "block";
                    successMessageShown = true;
                    return;
                }
            }

            if (rightPressed && paddleX < canvas.width - paddleWidth) {
                paddleX += 7;
            } else if (leftPressed && paddleX > 0) {
                paddleX -= 7;
            }

            x += dx;
            y += dy;

            if (gameStarted) {
                requestAnimationFrame(draw);
            }
        }

        function sendToGoogleSheets() {
            var company = document.getElementById("company").value;
            var employeeId = document.getElementById("employeeId").value;
            var name = document.getElementById("name").value;
            var elapsedTime = localStorage.getItem("elapsedTime");
        
            var data = {
                company: company,
                employeeId: employeeId,
                name: name,
                elapsedTime: elapsedTime
            };
        
            // ë¡œë”© ìŠ¤í¬ë¦° í‘œì‹œ
            showLoadingScreen();
        
            fetch('https://script.google.com/macros/s/AKfycbyswWzyoqno9M57sszIKFon6chfRVTswC0mzzixDp3FXGqChQdOquAZoNe1GTh2CsVbDg/exec', {
                method: 'POST',
                headers: {
                    "Content-Type": "text/plain;charset=utf-8",
                },
                body: JSON.stringify(data),
                mode: 'cors'
            })
            .then(response => {
                if (response.ok) {
                    console.log('Google Sheets ì „ì†¡ ì„±ê³µ:', response);
                    alert('ì´ë²¤íŠ¸ ì‘ëª¨ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                } else {
                    console.error('Google Sheets ì „ì†¡ ì—ëŸ¬:', response);
                    alert('ì´ë²¤íŠ¸ ì‘ëª¨ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            })
            .catch((error) => {
                console.error('Google Sheets ì „ì†¡ ì—ëŸ¬:', error);
                alert('ì´ë²¤íŠ¸ ì‘ëª¨ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            })
            .finally(() => {
                saveLocalRanking(data);
                // í¼ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                document.getElementById("company").value = "";
                document.getElementById("employeeId").value = "";
                document.getElementById("name").value = "";
        
                // í¼ê³¼ ë©”ì‹œì§€ í‘œì‹œ ì—…ë°ì´íŠ¸
                document.getElementById("formContainer").style.display = "none";
                document.getElementById("message").style.display = "block";
        
                document.getElementById("gameCanvas").style.display = "none";
                document.getElementById("startMessage").style.display = "block";
                document.getElementById("exit").style.display = "block";
                
                // 4ì´ˆ ë”œë ˆì´ í›„ ë¡œë”© ìŠ¤í¬ë¦° ìˆ¨ê¸°ê³  ë­í‚¹ ë³´ë“œ í‘œì‹œ
                setTimeout(() => {
                    hideLoadingScreen();
                    displayLocalRankingBoard();
                }, 4000); // 4000 ë°€ë¦¬ì´ˆ = 4ì´ˆ
            });
        }


        function getLocalRankings() {
            var rankings = JSON.parse(localStorage.getItem('rankings')) || [];
            return rankings;
        }

        function saveLocalRanking(newEntry) {
            var rankings = getLocalRankings();
            rankings.push(newEntry);
            rankings.sort(function(a, b) {
                return a.elapsedTime - b.elapsedTime;
            });
            rankings = rankings.slice(0, 5);
            localStorage.setItem('rankings', JSON.stringify(rankings));
        }

        function displayLocalRankingBoard() {
          fetch('https://script.google.com/macros/s/AKfycbwuNc3Je7sJ1iaOE_Wxk9x_lfPdccCenupOcoPWWDAY0qQjvVdUusHOw8omEiFIAw9ZuQ/exec', {
            mode: 'cors'
          })
          .then(response => {
            if (!response.ok) {
              throw new Error('Network response was not ok');
            }
            return response.json();
          })
          .then(data => {
            console.log(data); // ë°›ì•„ì˜¨ ë°ì´í„°ë¥¼ ì½˜ì†”ì— ì¶œë ¥í•˜ì—¬ í™•ì¸í•©ë‹ˆë‹¤.
            var rankingBoard = document.getElementById("rankingBoard");
            rankingBoard.style.display = "block";
            rankingBoard.innerHTML = "<h2>ê²Œì„ ë­í‚¹</h2>";
            // ë°ì´í„°ë¥¼ ì²˜ë¦¬í•  ë•Œ ì²« ë²ˆì§¸ í•­ëª©ì„ ì œê±°í•œ í›„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
            data.slice(0).forEach((entry, index) => {
              var entryElement = document.createElement("div");
              entryElement.className = "rank";
              entryElement.innerHTML = `<span class="name">${index + 1}ë“± ${entry.name} </span><span class="time">${entry.elapsedTime.toFixed(2)}ì´ˆ</span>`;
              rankingBoard.appendChild(entryElement);
            });
          })
          .catch(error => {
            console.error('Error fetching data:', error);
          });
        }

        

    </script>
</body>
</html>
